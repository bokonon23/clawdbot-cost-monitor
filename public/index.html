<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenClaw Cost Monitor</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .status {
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px 20px;
      display: inline-block;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    
    .status.connected {
      background: rgba(76, 175, 80, 0.3);
    }
    
    .status.error {
      background: rgba(244, 67, 54, 0.3);
    }
    
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card h2 {
      font-size: 0.9rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    
    .card .value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .card .subtext {
      font-size: 0.9rem;
      color: #999;
    }
    
    .model-breakdown {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .model-breakdown h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: #333;
    }
    
    .model-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .model-name {
      font-weight: 600;
      color: #333;
    }
    
    .model-stats {
      text-align: right;
    }
    
    .model-cost {
      font-size: 1.2rem;
      font-weight: bold;
      color: #667eea;
    }
    
    .model-tokens {
      font-size: 0.85rem;
      color: #999;
      margin-top: 3px;
    }
    
    .sessions {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .sessions h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: #333;
    }
    
    .session-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .session-item:last-child {
      border-bottom: none;
    }
    
    .session-key {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .session-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #666;
    }
    
    .error-message {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .error-message h2 {
      color: #f44336;
      margin-bottom: 15px;
    }
    
    .error-message p {
      color: #666;
      line-height: 1.6;
    }
    
    .projection-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .projection-card h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      opacity: 0.9;
    }
    
    .projection-value {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .projection-details {
      opacity: 0.9;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    .budget-alert {
      background: #ff9800;
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(255,152,0,0.3);
    }
    
    .budget-alert.warning {
      background: #f44336;
    }
    
    .chart-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .chart-container h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: #333;
    }
    
    footer {
      text-align: center;
      color: white;
      margin-top: 40px;
      opacity: 0.8;
    }
    
    .loading {
      text-align: center;
      color: white;
      font-size: 1.2rem;
      padding: 40px;
    }
    
    .settings-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      font-size: 1.5rem;
      transition: transform 0.2s;
    }
    
    .settings-button:hover {
      transform: scale(1.1);
    }
    
    .settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .settings-modal.active {
      display: flex;
    }
    
    .settings-content {
      background: white;
      border-radius: 15px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .settings-content h2 {
      margin-bottom: 25px;
      color: #333;
    }
    
    .setting-item {
      margin-bottom: 25px;
    }
    
    .setting-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .setting-item input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .setting-item input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .setting-item p {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #999;
    }
    
    .settings-buttons {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #555;
    }
    
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state h3 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #666;
    }
    
    .empty-state p {
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      border-bottom: 1px dotted #999;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 280px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 8px;
      padding: 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -140px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      line-height: 1.4;
    }
    
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <button class="settings-button" onclick="openSettings()">‚öôÔ∏è</button>
  
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <h2>‚öôÔ∏è Settings</h2>
      
      <div class="setting-item">
        <label for="budgetInput">Monthly Budget ($)</label>
        <input type="number" id="budgetInput" placeholder="50" min="1" step="1">
        <p>Set your monthly AI spending budget. You'll get alerts when you're on track to exceed it.</p>
      </div>
      
      <div class="settings-buttons">
        <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBudget()">Save</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <header>
      <h1>üí∞ OpenClaw Cost Monitor</h1>
      <p>Track your AI spending in real-time</p>
      <div class="status" id="status">Connecting...</div>
    </header>
    
    <div id="content">
      <div class="loading">Loading data...</div>
    </div>
    
    <footer>
      <p>Built with ‚ù§Ô∏è for the OpenClaw community</p>
    </footer>
  </div>
  
  <script>
    let ws;
    let costChart = null;
    
    // Load budget from localStorage (default $50)
    function getBudget() {
      const saved = localStorage.getItem('monthlyBudget');
      return saved ? parseFloat(saved) : 50;
    }
    
    function setBudget(amount) {
      localStorage.setItem('monthlyBudget', amount);
    }
    
    function openSettings() {
      document.getElementById('budgetInput').value = getBudget();
      document.getElementById('settingsModal').classList.add('active');
    }
    
    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    function saveBudget() {
      const budget = parseFloat(document.getElementById('budgetInput').value);
      if (budget && budget > 0) {
        setBudget(budget);
        closeSettings();
        // Reload data to update alerts
        loadProjection();
      } else {
        alert('Please enter a valid budget amount');
      }
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('settingsModal');
      if (e.target === modal) {
        closeSettings();
      }
    });
    
    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);
      
      ws.onopen = () => {
        updateStatus('connected', 'üü¢ Connected');
        loadHistoricalData();
        loadProjection();
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        renderData(data);
      };
      
      ws.onerror = () => {
        updateStatus('error', 'üî¥ Connection Error');
      };
      
      ws.onclose = () => {
        updateStatus('error', 'üü° Disconnected');
        setTimeout(connect, 3000);
      };
    }
    
    async function loadHistoricalData() {
      try {
        const response = await fetch('/api/history?days=7');
        const history = await response.json();
        renderChart(history);
      } catch (error) {
        console.error('Failed to load history:', error);
      }
    }
    
    async function loadProjection() {
      try {
        const response = await fetch('/api/projection');
        const projection = await response.json();
        renderProjection(projection);
      } catch (error) {
        console.error('Failed to load projection:', error);
      }
    }
    
    function updateStatus(className, text) {
      const status = document.getElementById('status');
      status.className = `status ${className}`;
      status.textContent = text;
    }
    
    function formatCost(cost) {
      return `$${cost.toFixed(2)}`;
    }
    
    function formatTokens(tokens) {
      if (tokens >= 1000000) {
        return `${(tokens / 1000000).toFixed(2)}M`;
      } else if (tokens >= 1000) {
        return `${(tokens / 1000).toFixed(1)}K`;
      }
      return tokens.toString();
    }
    
    function renderChart(history) {
      const ctx = document.getElementById('costChart');
      if (!ctx) return;
      
      if (history.length === 0) {
        // Show empty state instead of blank chart
        const container = ctx.closest('.chart-container');
        if (container) {
          const chartDiv = container.querySelector('div');
          chartDiv.innerHTML = `
            <div class="empty-state">
              <h3>üìä Graph Coming Soon</h3>
              <p>Your cost history will appear here after 24 hours of usage.</p>
              <p style="margin-top: 10px;">The app automatically tracks your spending every hour.</p>
            </div>
          `;
        }
        return;
      }
      
      const labels = history.map(h => {
        const date = new Date(h.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      
      const costs = history.map(h => h.cost);
      
      if (costChart) {
        costChart.destroy();
      }
      
      costChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Daily Cost ($)',
            data: costs,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(2);
                }
              }
            }
          }
        }
      });
    }
    
    function renderProjection(projection) {
      if (!projection || !projection.projectedMonthTotal) {
        // Show empty state for projection
        const existingProjection = document.querySelector('.projection-card');
        if (!existingProjection) {
          const emptyProjectionHtml = `
            <div class="projection-card">
              <h2>üìä Monthly Projection</h2>
              <div class="projection-details">
                <div class="empty-state" style="padding: 20px 0; color: rgba(255,255,255,0.8);">
                  <p>Your monthly cost projection will appear here after 24-48 hours of usage.</p>
                  <p style="margin-top: 10px;">We need at least 2 days of data to calculate an accurate projection.</p>
                </div>
              </div>
            </div>
          `;
          const contentDiv = document.getElementById('content');
          contentDiv.insertAdjacentHTML('afterbegin', emptyProjectionHtml);
        }
        return;
      }
      
      const budget = getBudget();
      const projectionHtml = `
        <div class="projection-card">
          <h2>üìä Monthly Projection</h2>
          <div class="projection-value">$${projection.projectedMonthTotal.toFixed(2)}</div>
          <div class="projection-details">
            At your current rate of <strong>$${projection.avgDailyRate.toFixed(2)}/day</strong>, 
            you're on track to spend <strong>$${projection.projectedMonthTotal.toFixed(2)}</strong> this month.
            <br><br>
            Current month total: $${projection.currentMonthTotal.toFixed(2)} ¬∑ 
            ${projection.daysRemaining} days remaining ¬∑ 
            Budget: $${budget.toFixed(0)}/month
          </div>
        </div>
      `;
      
      const existingProjection = document.querySelector('.projection-card');
      if (existingProjection) {
        existingProjection.outerHTML = projectionHtml;
      } else {
        const contentDiv = document.getElementById('content');
        contentDiv.insertAdjacentHTML('afterbegin', projectionHtml);
      }
      
      // Show budget alert if over threshold
      if (projection.projectedMonthTotal > budget) {
        const percentOver = ((projection.projectedMonthTotal / budget) - 1) * 100;
        const alertHtml = `
          <div class="budget-alert ${projection.projectedMonthTotal > budget * 1.5 ? 'warning' : ''}">
            ‚ö†Ô∏è Budget Alert: You're projected to exceed your $${budget.toFixed(0)} monthly budget by ${percentOver.toFixed(0)}%!
          </div>
        `;
        
        const existingAlert = document.querySelector('.budget-alert');
        if (existingAlert) {
          existingAlert.outerHTML = alertHtml;
        } else {
          const contentDiv = document.getElementById('content');
          contentDiv.insertAdjacentHTML('afterbegin', alertHtml);
        }
      }
    }
    
    function renderData(data) {
      if (data.error) {
        document.getElementById('content').innerHTML = `
          <div class="error-message">
            <h2>‚ö†Ô∏è Error</h2>
            <p>${data.error}</p>
            <p style="margin-top: 15px;">Make sure OpenClaw (Clawdbot) is running and sessions.json exists.</p>
          </div>
        `;
        return;
      }
      
      const totalTokens = data.totalInputTokens + data.totalOutputTokens + data.totalCacheReadTokens + data.totalCacheWriteTokens;
      const budget = getBudget();
      
      let html = ``;
      
      // Check if current spending exceeds budget (immediate alert, no projection needed)
      if (data.totalCost > budget * 0.8) {
        const percentUsed = ((data.totalCost / budget) * 100).toFixed(0);
        const isOverBudget = data.totalCost > budget;
        
        const alertHtml = `
          <div class="budget-alert ${isOverBudget ? 'warning' : ''}">
            ${isOverBudget ? 'üö®' : '‚ö†Ô∏è'} ${isOverBudget ? 'Over Budget!' : 'Budget Warning'}: 
            You've spent $${data.totalCost.toFixed(2)} of your $${budget.toFixed(0)} monthly budget (${percentUsed}%)
          </div>
        `;
        html += alertHtml;
      }
      
      // Keep projection if it exists
      const existingProjection = document.querySelector('.projection-card');
      if (existingProjection) html += existingProjection.outerHTML;
      
      // Calculate what cost WOULD be without caching
      const costWithoutCaching = ((data.totalInputTokens + data.totalCacheReadTokens) / 1_000_000) * 3.00 + 
                                 (data.totalOutputTokens / 1_000_000) * 15.00;
      const savingsFromCaching = costWithoutCaching - data.totalCost;
      const savingsPercent = costWithoutCaching > 0 ? ((savingsFromCaching / costWithoutCaching) * 100) : 0;
      
      // Show cache savings if significant
      let cachingExplainer = '';
      if (data.totalCacheReadTokens > 0 && savingsFromCaching > 0.10) {
        cachingExplainer = `
          <div class="model-breakdown" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; margin-bottom: 30px;">
            <h2 style="color: white;">üíö Prompt Caching Savings</h2>
            <div style="font-size: 1.8rem; font-weight: bold; margin-bottom: 10px;">
              $${savingsFromCaching.toFixed(2)} saved (${savingsPercent.toFixed(0)}% off)
            </div>
            <div style="opacity: 0.95; line-height: 1.6;">
              Clawdbot uses <strong>Prompt Caching</strong> to dramatically reduce costs. Instead of sending your entire chat 
              history with every message, it stores repeated context and reuses it at <strong>90% discount</strong>.
              <br><br>
              <strong>Your Token Breakdown:</strong><br>
              ‚Ä¢ New input: ${formatTokens(data.totalInputTokens)} tokens √ó $3.00/M = $${((data.totalInputTokens/1_000_000)*3).toFixed(3)}<br>
              ‚Ä¢ AI responses: ${formatTokens(data.totalOutputTokens)} tokens √ó $15.00/M = $${((data.totalOutputTokens/1_000_000)*15).toFixed(3)}<br>
              ‚Ä¢ Cached reads: ${formatTokens(data.totalCacheReadTokens)} tokens √ó $0.30/M = $${((data.totalCacheReadTokens/1_000_000)*0.30).toFixed(3)} üí∞<br>
              ${data.totalCacheWriteTokens > 0 ? `‚Ä¢ Cache writes: ${formatTokens(data.totalCacheWriteTokens)} tokens √ó $3.75/M = $${((data.totalCacheWriteTokens/1_000_000)*3.75).toFixed(3)}<br>` : ''}
            </div>
          </div>
        `;
      }
      
      html += `
        <div class="cards">
          <div class="card">
            <h2>Total Cost</h2>
            <div class="value">${formatCost(data.totalCost)}</div>
            <div class="subtext">All-time spending</div>
          </div>
          
          <div class="card">
            <h2>
              <span class="tooltip">Total Tokens
                <span class="tooltiptext"><strong>Tokens = Pieces of Text</strong><br><br>1 token ‚âà 4 characters or ¬æ of a word.<br><br><strong>Input:</strong> Your messages + chat history sent to AI<br><strong>Output:</strong> AI's response back to you<br><strong>Cached:</strong> Reused history (90% cheaper!)<br><br>More tokens = higher cost, but caching helps a lot!</span>
              </span>
            </h2>
            <div class="value">${formatTokens(totalTokens)}</div>
            <div class="subtext">${formatTokens(data.totalCacheReadTokens)} cached (90% discount)</div>
          </div>
          
          <div class="card">
            <h2>Sessions</h2>
            <div class="value">${data.sessions.length}</div>
            <div class="subtext">${Object.keys(data.byModel).length} model${Object.keys(data.byModel).length !== 1 ? 's' : ''}</div>
          </div>
        </div>
        
        ${cachingExplainer}
      `;
      
      // 7-day chart
      html += `
        <div class="chart-container">
          <h2>üìà 7-Day Cost History</h2>
          <div style="height: 250px;">
            <canvas id="costChart"></canvas>
          </div>
        </div>
      `;
      
      // Model breakdown
      const sortedModels = Object.entries(data.byModel).sort((a, b) => b[1].cost - a[1].cost);
      
      if (sortedModels.length > 0) {
        html += `<div class="model-breakdown"><h2>üí∞ Cost by Model</h2>`;
        
        sortedModels.forEach(([model, stats]) => {
          const percentage = ((stats.cost / data.totalCost) * 100).toFixed(1);
          const totalModelTokens = stats.inputTokens + stats.outputTokens + stats.cacheReadTokens + stats.cacheWriteTokens;
          const avgCostPerConvo = stats.sessions > 0 ? (stats.cost / stats.sessions) : 0;
          
          // Simplify model names
          const displayName = model.replace('anthropic/', '').replace('openai/', '');
          
          // Build token breakdown string
          let tokenBreakdown = `${formatTokens(totalModelTokens)} total`;
          if (stats.cacheReadTokens > 0) {
            tokenBreakdown += ` (${formatTokens(stats.cacheReadTokens)} cached)`;
          }
          
          html += `
            <div class="model-item">
              <div>
                <div class="model-name">${displayName}</div>
                <div class="model-tokens">
                  ${stats.sessions} conversation${stats.sessions !== 1 ? 's' : ''} ¬∑ 
                  ${tokenBreakdown} ¬∑ 
                  Avg ${formatCost(avgCostPerConvo)}/chat
                </div>
              </div>
              <div class="model-stats">
                <div class="model-cost">${formatCost(stats.cost)}</div>
                <div class="model-tokens">${percentage}% of total</div>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      // Sessions
      if (data.sessions.length > 0) {
        html += `<div class="sessions"><h2>üí¨ Sessions</h2>`;
        
        data.sessions.forEach(session => {
          html += `
            <div class="session-item">
              <div class="session-key">${session.key}</div>
              <div class="session-details">
                <span>${session.model}</span>
                <span>${formatTokens(session.inputTokens + session.outputTokens)} tokens ¬∑ ${formatCost(session.cost)}</span>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      document.getElementById('content').innerHTML = html;
      
      // Re-render chart and projection after updating content
      loadHistoricalData();
      loadProjection();
    }
    
    // Initialize
    connect();
    
    // Reload projection every 5 minutes
    setInterval(loadProjection, 5 * 60 * 1000);
  </script>
</body>
</html>
